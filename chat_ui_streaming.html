<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì ‘ê´€ AI ì±„íŒ… - LLM API ì„œë²„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #0f172a;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-history-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e2e8f0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item:hover {
            background: #475569;
        }

        .chat-history-item.active {
            background: #667eea;
            color: white;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #334155;
        }

        .model-select {
            width: 100%;
            padding: 12px;
            background: #334155;
            color: white;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .model-select:hover {
            border-color: #667eea;
            background: #3f4f63;
        }

        .model-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .model-select optgroup {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            padding: 8px;
        }

        .model-select option {
            background: #334155;
            color: #e2e8f0;
            padding: 10px;
        }

        /* ê¸°ì—…/ë³‘ì› ì„ íƒ ì„¹ì…˜ */
        .org-section {
            margin-top: 15px;
            padding: 12px;
            background: #273548;
            border-radius: 8px;
            border: 1px solid #3d4f66;
        }

        .org-section-title {
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .custom-input {
            width: 100%;
            padding: 10px 12px;
            margin-top: 8px;
            background: #334155;
            color: white;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .custom-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-input::placeholder {
            color: #64748b;
        }

        .selected-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .selected-info span {
            color: #a5b4fc;
            font-size: 12px;
            font-weight: 500;
        }

        .settings-group {
            margin-top: 10px;
        }

        .settings-group label {
            display: block;
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .settings-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #475569;
            outline: none;
            -webkit-appearance: none;
        }

        .settings-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }

        .settings-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.6);
        }

        .settings-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }

        .settings-group input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.6);
        }

        .temp-value {
            color: #e2e8f0;
            font-weight: 600;
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f172a;
        }

        .chat-header {
            padding: 20px 30px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            color: white;
            font-size: 20px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            color: #10b981;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .status-badge:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ë©”ì‹œì§€ ì˜ì—­ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .assistant-message .message-avatar {
            background: #334155;
        }

        .message-content {
            flex: 1;
            max-width: 800px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .message-role {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            color: #64748b;
            font-size: 12px;
        }

        .message-text {
            color: #cbd5e1;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #1e293b;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .message-text:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .user-message .message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-message .message-text:hover {
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .system-message {
            text-align: center;
            margin: 20px 0;
        }

        .system-message .message-text {
            display: inline-block;
            background: #334155;
            color: #94a3b8;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 13px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
            padding: 40px;
        }

        .welcome-screen h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-screen p {
            color: #94a3b8;
            font-size: 1.1em;
            margin-bottom: 40px;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 600px;
        }

        .example-prompt {
            padding: 20px;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .example-prompt:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .example-prompt .icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .example-prompt .title {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .example-prompt .desc {
            color: #64748b;
            font-size: 13px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            padding: 20px 30px;
            background: #1e293b;
            border-top: 1px solid #334155;
        }

        .system-prompt-toggle {
            margin-bottom: 12px;
        }

        .system-prompt-btn {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #334155;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .system-prompt-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .prompt-title {
            flex: 1;
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
        }

        .prompt-action-btn {
            padding: 8px 12px;
            background: #334155;
            color: #94a3b8;
            border: 1px solid #475569;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .prompt-action-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .prompt-action-btn.save {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .prompt-action-btn.save:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        .system-prompt-input {
            display: none;
            margin-bottom: 12px;
        }

        .system-prompt-input.active {
            display: block;
        }

        .system-prompt-input textarea {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
        }

        .system-prompt-input textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 14px 18px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 150px;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-hint {
            margin-top: 8px;
            color: #64748b;
            font-size: 12px;
            text-align: center;
            padding: 4px 0;
        }

        .input-hint strong {
            color: #94a3b8;
            font-weight: 600;
        }

        .send-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .resume-info {
            display: none;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            color: #10b981;
            font-size: 13px;
        }

        .resume-info.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .resume-info .filename {
            font-weight: 600;
        }

        .resume-info .remove-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .resume-info .remove-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #1e293b;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .clear-btn {
            padding: 8px 16px;
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }

        .clear-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* RAG ì„¹ì…˜ */
        .rag-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #334155;
        }

        .rag-section-title {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rag-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .rag-toggle label {
            color: #e2e8f0;
            font-size: 13px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .rag-upload-btn {
            width: 100%;
            padding: 10px 14px;
            background: #334155;
            color: #e2e8f0;
            border: 1px dashed #475569;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .rag-upload-btn:hover {
            border-color: #667eea;
            background: #3f4f63;
        }

        .rag-docs-list {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .rag-doc-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #334155;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
            color: #e2e8f0;
        }

        .rag-doc-item .doc-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .rag-doc-item .doc-delete {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 14px;
        }

        .rag-doc-item .doc-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
        }

        .rag-status {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 8px;
        }

        .rag-status.active {
            color: #10b981;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
            transition: all 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .example-prompts {
                grid-template-columns: 1fr;
            }
        }

        /* í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ */
        .prompt-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .prompt-modal-overlay.active {
            display: flex;
        }

        .prompt-modal {
            width: 90%;
            max-width: 900px;
            height: 85%;
            background: #1e293b;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .prompt-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
        }

        .prompt-modal-header h3 {
            color: #e2e8f0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-modal-close {
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .prompt-modal-close:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .prompt-modal-body {
            flex: 1;
            padding: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .prompt-modal-textarea {
            flex: 1;
            width: 100%;
            padding: 16px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            transition: border-color 0.3s;
        }

        .prompt-modal-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .prompt-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid #334155;
            background: #1a2332;
            border-radius: 0 0 16px 16px;
        }

        .prompt-modal-info {
            color: #64748b;
            font-size: 13px;
        }

        .prompt-modal-actions {
            display: flex;
            gap: 12px;
        }

        .prompt-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-modal-btn.cancel {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
        }

        .prompt-modal-btn.cancel:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .prompt-modal-btn.save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .prompt-modal-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .prompt-modal-btn.reload {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
        }

        .prompt-modal-btn.reload:hover {
            background: #3f4f63;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¤– ë©´ì ‘ê´€ AI</h2>
                <button class="new-chat-btn" onclick="startNewChat()">
                    â• ìƒˆ ëŒ€í™” ì‹œì‘
                </button>
            </div>

            <div class="sidebar-content" id="chatHistory">
                <!-- ëŒ€í™” ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div class="sidebar-footer">
                <select class="model-select" id="modelSelect">
                    <optgroup label="ğŸš€ vLLM-MLX (Apple Silicon ìµœì í™”)">
                        <option value="vllm-qwen3-30b-a3b" selected>Qwen3 30B MoE (217 t/s) ğŸ†</option>
                    </optgroup>
                    <optgroup label="â˜ï¸ í´ë¼ìš°ë“œ API">
                        <option value="gpt-5-mini">GPT-5 Mini (OpenAI)</option>
                    </optgroup>
                </select>

                <!-- ê¸°ì—…/ë³‘ì› ì„ íƒ ì„¹ì…˜ -->
                <div class="org-section">
                    <div class="org-section-title">ğŸ¢ ë©´ì ‘ ëŒ€ìƒ ì„ íƒ</div>

                    <div class="settings-group">
                        <label>ìœ í˜•</label>
                        <select class="model-select" id="orgTypeSelect" onchange="onOrgTypeChange()">
                            <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                            <option value="company">ì¼ë°˜ ê¸°ì—…</option>
                            <option value="hospital">ë³‘ì›</option>
                        </select>
                    </div>

                    <div class="settings-group" id="orgSelectGroup" style="display: none;">
                        <label>ê¸°ì—…/ë³‘ì›ëª…</label>
                        <select class="model-select" id="orgSelect" onchange="onOrgChange()">
                            <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                        </select>
                        <input type="text" class="custom-input" id="customOrgInput" placeholder="ê¸°ì—…/ë³‘ì›ëª… ì§ì ‘ ì…ë ¥" style="display: none;">
                    </div>

                    <div class="settings-group" id="jobSelectGroup" style="display: none;">
                        <label>ì§ë¬´</label>
                        <select class="model-select" id="jobSelect" onchange="onJobChange()">
                            <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                        </select>
                        <input type="text" class="custom-input" id="customJobInput" placeholder="ì§ë¬´ ì§ì ‘ ì…ë ¥" style="display: none;">
                    </div>

                    <div class="selected-info" id="selectedInfo" style="display: none;">
                        <span id="selectedOrgJob"></span>
                    </div>

                    <!-- ì±„ìš©ê³µê³  ì…ë ¥ (ì„ íƒ) -->
                    <div class="settings-group" style="margin-top: 12px;">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            ğŸ“‹ ì±„ìš©ê³µê³ /ì§ë¬´ê¸°ìˆ ì„œ <span style="color: #64748b; font-size: 11px;">(ì„ íƒ)</span>
                        </label>
                        <textarea class="custom-input" id="jobPostingInput"
                            placeholder="ì±„ìš©ê³µê³  ë˜ëŠ” ì§ë¬´ê¸°ìˆ ì„œ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."
                            style="min-height: 80px; resize: vertical; margin-top: 6px;"></textarea>
                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                            ì…ë ¥ ì‹œ í”„ë¡¬í”„íŠ¸ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <label>
                        Temperature: <span class="temp-value" id="tempValue">0.7</span>
                    </label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                </div>

                <!-- RAG ì„¹ì…˜ -->
                <div class="rag-section">
                    <div class="rag-section-title">
                        ğŸ“š ë¬¸ì„œ ì°¸ì¡° (RAG)
                    </div>

                    <div class="rag-toggle">
                        <label>RAG í™œì„±í™”</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ragEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <input type="file" id="ragFileInput" accept=".pdf" style="display: none;" onchange="uploadRAGDocument(event)">
                    <button class="rag-upload-btn" onclick="document.getElementById('ragFileInput').click()">
                        ğŸ“„ PDF ë¬¸ì„œ ì—…ë¡œë“œ
                    </button>

                    <div class="rag-docs-list" id="ragDocsList">
                        <!-- ì—…ë¡œë“œëœ ë¬¸ì„œ ëª©ë¡ -->
                    </div>

                    <div class="rag-status" id="ragStatus">
                        ë¬¸ì„œ 0ê°œ ë“±ë¡ë¨
                    </div>
                </div>

                <!-- ì§ˆë¬¸ì…‹ RAG ì„¹ì…˜ -->
                <div class="rag-section" style="margin-top: 15px;">
                    <div class="rag-section-title">
                        ğŸ’¡ ì§ˆë¬¸ì…‹ ì°¸ì¡° (RAG)
                    </div>

                    <div class="rag-toggle">
                        <label>ì§ˆë¬¸ì…‹ RAG í™œì„±í™”</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="questionSetRagEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="rag-status" id="questionSetRagStatus" style="font-size: 11px;">
                        ì§ë¬´ ì„ íƒ ì‹œ ê´€ë ¨ ì§ˆë¬¸ ìë™ ê²€ìƒ‰
                    </div>
                </div>

                <!-- ì´ë ¥ì„œ RAG ì„¹ì…˜ -->
                <div class="rag-section" style="margin-top: 15px;">
                    <div class="rag-section-title">
                        ğŸ“„ ì´ë ¥ì„œ ì°¸ì¡° (RAG)
                    </div>

                    <div class="rag-toggle">
                        <label>ì´ë ¥ì„œ RAG í™œì„±í™”</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="resumeRagEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <input type="file" id="resumeFileInput" accept=".pdf" style="display: none;" onchange="uploadResumeDocument(event)">
                    <button class="rag-upload-btn" id="resumeUploadBtn" onclick="document.getElementById('resumeFileInput').click()">
                        ğŸ“„ ì´ë ¥ì„œ PDF ì—…ë¡œë“œ
                    </button>

                    <div class="rag-status" id="resumeRagStatus" style="font-size: 11px;">
                        ì´ë ¥ì„œ ì²¨ë¶€ ì‹œ ê´€ë ¨ ë‚´ìš© ìë™ ê²€ìƒ‰
                    </div>
                </div>

                <button class="clear-btn" onclick="clearAllChats()" style="margin-top: 15px;">
                    ğŸ—‘ï¸ ëª¨ë“  ëŒ€í™” ì‚­ì œ
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="chat-area">
            <div class="chat-header">
                <h1>ë©´ì ‘ê´€ AI ì±„íŒ…</h1>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span id="statusText">ì„œë²„ ì—°ê²° ì¤‘...</span>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h2>ğŸ‘‹ ë©´ì ‘ê´€ AIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                    <p>ì „ë¬¸ ë©´ì ‘ê´€ì´ ë‹¹ì‹ ì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê³  ì§ˆë¬¸ì„ ì œê³µí•©ë‹ˆë‹¤</p>

                    <div class="example-prompts">
                        <div class="example-prompt" onclick="setExamplePrompt('frontend')">
                            <div class="icon">ğŸ’¼</div>
                            <div class="title">í”„ë¡ íŠ¸ì—”ë“œ ë©´ì ‘</div>
                            <div class="desc">React ê°œë°œì 3ë…„ ê²½ë ¥</div>
                        </div>
                        <div class="example-prompt" onclick="setExamplePrompt('backend')">
                            <div class="icon">ğŸ–¥ï¸</div>
                            <div class="title">ë°±ì—”ë“œ ë©´ì ‘</div>
                            <div class="desc">Node.js/Python 5ë…„ ê²½ë ¥</div>
                        </div>
                        <div class="example-prompt" onclick="setExamplePrompt('data')">
                            <div class="icon">ğŸ“Š</div>
                            <div class="title">ë°ì´í„° ë¶„ì„ê°€</div>
                            <div class="desc">Python/SQL 2ë…„ ê²½ë ¥</div>
                        </div>
                        <div class="example-prompt" onclick="setExamplePrompt('design')">
                            <div class="icon">ğŸ¨</div>
                            <div class="title">UI/UX ë””ìì´ë„ˆ</div>
                            <div class="desc">Figma 4ë…„ ê²½ë ¥</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="system-prompt-toggle">
                    <button class="system-prompt-btn" id="systemPromptBtn" onclick="openPromptModal()">
                        ğŸ“ í”„ë¡¬í”„íŠ¸ í¸ì§‘
                    </button>
                </div>

                <!-- ìˆ¨ê²¨ì§„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ë‚´ë¶€ ì‚¬ìš©) -->
                <textarea id="systemPrompt" style="display: none;">ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”. /nothink</textarea>

                <div class="resume-info" id="resumeInfo">
                    <span>ğŸ“„ <span class="filename" id="resumeFilename"></span> ì²¨ë¶€ë¨</span>
                    <button class="remove-btn" onclick="removeResume()">âœ• ì œê±°</button>
                </div>

                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">
                        <span>ì „ì†¡</span>
                        <span>ğŸ“¤</span>
                    </button>
                </div>
                <div class="input-hint">
                    ğŸ’¡ <strong>Enter</strong>ë¡œ ì „ì†¡ | <strong>Shift + Enter</strong>ë¡œ ì¤„ë°”ê¿ˆ
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL ìë™ ê°ì§€
        const API_BASE_URL = window.location.origin;
        const API_ENDPOINT = `${API_BASE_URL}/v1/chat/completions`;
        const HEALTH_ENDPOINT = `${API_BASE_URL}/health`;
        const RAG_ENDPOINT = `${API_BASE_URL}/rag`;
        const RESUME_ENDPOINT = `${API_BASE_URL}/resume`;
        const PROMPTS_ENDPOINT = `${API_BASE_URL}/prompts`;

        // ì „ì—­ ìƒíƒœ
        let conversations = JSON.parse(localStorage.getItem('conversations')) || [];
        let currentConversationId = null;
        let messageHistory = [];
        let isSending = false; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€ í”Œë˜ê·¸
        let resumeSessionId = null; // ì´ë ¥ì„œ ì„¸ì…˜ ID
        let resumeSummary = null; // ì´ë ¥ì„œ ìš”ì•½

        // ê¸°ì—…/ë³‘ì› ì„ íƒ ë°ì´í„°
        let orgData = null;
        let selectedOrgType = '';
        let selectedOrg = '';
        let selectedJob = '';
        let currentQuestionSet = null;  // í˜„ì¬ ë¡œë“œëœ ì§ˆë¬¸ì…‹

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            loadChatHistory();
            setupEventListeners();
            loadExpertPrompt();  // ì „ë¬¸ ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
            loadRAGDocuments();  // RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ

            // ì €ì¥ëœ ëŒ€í™”ê°€ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ëŒ€í™” ë¡œë“œ
            if (conversations.length > 0) {
                loadConversation(conversations[0].id);
            }
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // Temperature ìŠ¬ë¼ì´ë”
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('tempValue').textContent = e.target.value;
            });

            // ì „ì†¡ ë²„íŠ¼ í´ë¦­
            document.getElementById('sendBtn').addEventListener('click', () => {
                sendMessage();
            });

            // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            // í•œê¸€ IME ì¡°í•© ì¤‘ì—ëŠ” ì „ì†¡í•˜ì§€ ì•ŠìŒ (isComposing ì²´í¬)
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ìë™ ë†’ì´ ì¡°ì ˆ
            document.getElementById('messageInput').addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            });

            // ì§ì ‘ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('customOrgInput').addEventListener('input', updateSelectedInfo);
            document.getElementById('customJobInput').addEventListener('input', updateSelectedInfo);
        }

        // ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkServerStatus() {
            try {
                const response = await fetch(HEALTH_ENDPOINT);
                const data = await response.json();

                if (data.status === 'ok') {
                    document.getElementById('statusText').textContent = 'ì„œë²„ ì •ìƒ';
                } else {
                    document.getElementById('statusText').textContent = 'ì¼ë¶€ ì œí•œ';
                }
            } catch (error) {
                document.getElementById('statusText').textContent = 'ì—°ê²° ì‹¤íŒ¨';
            }
        }

        // ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ ì„¤ì •
        function setExamplePrompt(type) {
            const examples = {
                frontend: {
                    system: 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”.',
                    user: 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìë¡œ ì§€ì›í–ˆìŠµë‹ˆë‹¤. React 3ë…„ ê²½ë ¥ì´ ìˆê³  TypeScriptë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
                },
                backend: {
                    system: 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ë°±ì—”ë“œ ê°œë°œìì˜ ê¸°ìˆ  ì—­ëŸ‰ê³¼ ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì„ í‰ê°€í•˜ì„¸ìš”.',
                    user: 'Node.jsì™€ Pythonì„ ì‚¬ìš©í•˜ëŠ” ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. 5ë…„ ê²½ë ¥ì´ë©° MSA ì•„í‚¤í…ì²˜ ê²½í—˜ì´ ìˆìŠµë‹ˆë‹¤.'
                },
                data: {
                    system: 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ë°ì´í„° ë¶„ì„ê°€ì˜ ë¶„ì„ ëŠ¥ë ¥ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ë¥¼ í‰ê°€í•˜ì„¸ìš”.',
                    user: 'ë°ì´í„° ë¶„ì„ê°€ë¡œ ì§€ì›í•©ë‹ˆë‹¤. Python, SQL, Tableauë¥¼ ì‚¬ìš©í•˜ë©° 2ë…„ ê²½ë ¥ì…ë‹ˆë‹¤.'
                },
                design: {
                    system: 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. UI/UX ë””ìì´ë„ˆì˜ ë””ìì¸ ì‚¬ê³ ì™€ ì‚¬ìš©ì ì¤‘ì‹¬ ì ‘ê·¼ ë°©ì‹ì„ í‰ê°€í•˜ì„¸ìš”.',
                    user: 'UI/UX ë””ìì´ë„ˆì…ë‹ˆë‹¤. Figma, Adobe XDë¥¼ ì‚¬ìš©í•˜ë©° 4ë…„ ê²½ë ¥ì…ë‹ˆë‹¤.'
                }
            };

            const example = examples[type];
            document.getElementById('systemPrompt').value = example.system;
            document.getElementById('messageInput').value = example.user;

            // ìƒˆ ëŒ€í™” ì‹œì‘
            startNewChat();
        }

        // ìƒˆ ëŒ€í™” ì‹œì‘
        function startNewChat() {
            currentConversationId = Date.now().toString();
            messageHistory = [];

            // ì›°ì»´ ìŠ¤í¬ë¦° ìˆ¨ê¸°ê¸°
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
            addSystemMessage('ìƒˆë¡œìš´ ë©´ì ‘ ì„¸ì…˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
            const conversation = {
                id: currentConversationId,
                title: 'ìƒˆ ëŒ€í™”',
                messages: [],
                timestamp: Date.now()
            };
            conversations.unshift(conversation);
            saveConversations();
            loadChatHistory();
        }

        // ë©”ì‹œì§€ ì „ì†¡ (ìŠ¤íŠ¸ë¦¬ë°)
        async function sendMessage() {
            // ì¤‘ë³µ ì „ì†¡ ë°©ì§€
            if (isSending) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // ì „ì†¡ ì‹œì‘
            isSending = true;

            // ëŒ€í™”ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ì‹œì‘
            if (!currentConversationId) {
                startNewChat();
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // ë©”ì‹œì§€ ê¸°ë¡ì— ì¶”ê°€
            messageHistory.push({
                role: 'user',
                content: message
            });

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            showTypingIndicator();

            // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('sendBtn').disabled = true;

            // API ìš”ì²­ ì¤€ë¹„
            let systemPrompt = document.getElementById('systemPrompt').value.trim();
            const messages = [];

            // ì„ íƒëœ ê¸°ì—…/ì§ë¬´ ì •ë³´ ì¶”ê°€
            const orgJobInfo = getSelectedOrgJobInfo();
            if (orgJobInfo) {
                const orgJobContext = `\n\n[ë©´ì ‘ ëŒ€ìƒ ì •ë³´]\n- ìœ í˜•: ${orgJobInfo.type}\n- ê¸°ì—…/ë³‘ì›ëª…: ${orgJobInfo.organization || 'ë¯¸ì§€ì •'}\n- ì§€ì› ì§ë¬´: ${orgJobInfo.job || 'ë¯¸ì§€ì •'}`;
                systemPrompt += orgJobContext;
            }

            // ì±„ìš©ê³µê³ /ì§ë¬´ê¸°ìˆ ì„œ ì£¼ì… (í”„ë¡¬í”„íŠ¸ì˜ {JOB_POSTING} í”Œë ˆì´ìŠ¤í™€ë” ëŒ€ì²´)
            const jobPosting = document.getElementById('jobPostingInput').value.trim();
            if (jobPosting) {
                systemPrompt = systemPrompt.replace('{JOB_POSTING}', jobPosting);
            } else {
                // ì±„ìš©ê³µê³ ê°€ ì—†ìœ¼ë©´ í”Œë ˆì´ìŠ¤í™€ë” ì œê±°
                systemPrompt = systemPrompt.replace('{JOB_POSTING}', '(ì±„ìš©ê³µê³  ë¯¸ì…ë ¥)');
            }

            // ì§ˆë¬¸ì…‹ ì£¼ì… (í”„ë¡¬í”„íŠ¸ì˜ {JOB_ROLE_SET} í”Œë ˆì´ìŠ¤í™€ë” ëŒ€ì²´)
            // ì§ˆë¬¸ì…‹ RAGê°€ í™œì„±í™”ëœ ê²½ìš° ì „ì²´ ì£¼ì… ê±´ë„ˆëœ€ (RAGë¡œ ê´€ë ¨ ì§ˆë¬¸ë§Œ ê²€ìƒ‰)
            const useQuestionSetRag = document.getElementById('questionSetRagEnabled').checked;
            if (useQuestionSetRag) {
                // RAG ì‚¬ìš© ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ì œê±° (ì„œë²„ì—ì„œ ê´€ë ¨ ì§ˆë¬¸ë§Œ ì¶”ê°€ë¨)
                systemPrompt = systemPrompt.replace('{JOB_ROLE_SET}', '(RAGë¡œ ê´€ë ¨ ì§ˆë¬¸ ìë™ ê²€ìƒ‰)');
            } else if (currentQuestionSet) {
                systemPrompt = systemPrompt.replace('{JOB_ROLE_SET}', currentQuestionSet);
            } else {
                // ì§ˆë¬¸ì…‹ì´ ì—†ìœ¼ë©´ í”Œë ˆì´ìŠ¤í™€ë” ì œê±°
                systemPrompt = systemPrompt.replace('{JOB_ROLE_SET}', '(ì§ˆë¬¸ì…‹ ì—†ìŒ)');
            }

            if (systemPrompt) {
                messages.push({
                    role: 'system',
                    content: systemPrompt
                });
            }

            // ì´ì „ ëŒ€í™” ê¸°ë¡ í¬í•¨ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê´€ë¦¬)
            messages.push(...messageHistory);

            try {
                // RAG íŒŒë¼ë¯¸í„° í™•ì¸
                const ragEnabled = document.getElementById('ragEnabled').checked;
                const questionSetRagEnabled = document.getElementById('questionSetRagEnabled').checked;

                // ì§ˆë¬¸ì…‹ RAGìš© org_type, job_name ì¶”ì¶œ
                let questionSetOrgType = null;
                let questionSetJobName = null;
                if (questionSetRagEnabled && orgJobInfo) {
                    questionSetOrgType = orgJobInfo.type === 'ë³‘ì›' ? 'ë³‘ì›' : 'ì¼ë°˜ê¸°ì—…';
                    // ì§ë¬´ëª…ì—ì„œ ìŠ¬ë˜ì‹œ ì œê±° (API íŒŒë¼ë¯¸í„° í˜¸í™˜)
                    questionSetJobName = orgJobInfo.job ? orgJobInfo.job.replace(/\//g, '') : null;
                }

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-yMF-iN0klm6zt0E1D9nrYFejxozobeq-sNdNSqcU_hA'
                    },
                    body: JSON.stringify({
                        model: document.getElementById('modelSelect').value,
                        messages: messages,
                        temperature: parseFloat(document.getElementById('temperature').value),
                        stream: true,  // ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”
                        rag_enabled: ragEnabled,  // RAG í™œì„±í™” ì—¬ë¶€
                        rag_collection: 'default',
                        rag_top_k: 5,
                        // ì§ˆë¬¸ì…‹ RAG íŒŒë¼ë¯¸í„°
                        question_set_rag_enabled: questionSetRagEnabled,
                        question_set_org_type: questionSetOrgType,
                        question_set_job_name: questionSetJobName,
                        question_set_top_k: 5,
                        // ì´ë ¥ì„œ RAG íŒŒë¼ë¯¸í„°
                        resume_rag_enabled: document.getElementById('resumeRagEnabled').checked && resumeSessionId,
                        resume_session_id: resumeSessionId,
                        resume_top_k: 3
                    })
                });

                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
                hideTypingIndicator();

                // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
                let assistantMessage = '';
                const container = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant-message';

                const avatarEmoji = 'ğŸ¤–';
                const roleName = 'ë©´ì ‘ê´€';
                const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatarEmoji}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-role">${roleName}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text" id="streaming-message"></div>
                    </div>
                `;
                container.appendChild(messageDiv);

                const streamingMessageDiv = document.getElementById('streaming-message');
                const reader = response.body.getReader();

                // TextDecoderì˜ stream ì˜µì…˜ìœ¼ë¡œ UTF-8 ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const decoder = new TextDecoder('utf-8', { fatal: false });
                let lineBuffer = '';

                // UTF-8 ë¶ˆì™„ì „ ì‹œí€€ìŠ¤ ê°ì§€ í•¨ìˆ˜
                function findCompleteUtf8End(buffer) {
                    if (buffer.length === 0) return 0;

                    // ë’¤ì—ì„œë¶€í„° ë¶ˆì™„ì „í•œ ë©€í‹°ë°”ì´íŠ¸ ì‹œí€€ìŠ¤ ì°¾ê¸°
                    for (let i = Math.min(3, buffer.length - 1); i >= 0; i--) {
                        const idx = buffer.length - 1 - i;
                        const byte = buffer[idx];

                        // ë©€í‹°ë°”ì´íŠ¸ ì‹œì‘ ë°”ì´íŠ¸ì¸ì§€ í™•ì¸
                        if ((byte & 0xC0) === 0xC0) {  // 11xxxxxx - ë©€í‹°ë°”ì´íŠ¸ ì‹œì‘
                            let expectedLen;
                            if ((byte & 0xF8) === 0xF0) expectedLen = 4;       // 11110xxx
                            else if ((byte & 0xF0) === 0xE0) expectedLen = 3;  // 1110xxxx (í•œê¸€)
                            else if ((byte & 0xE0) === 0xC0) expectedLen = 2;  // 110xxxxx
                            else continue;

                            const actualLen = buffer.length - idx;
                            if (actualLen < expectedLen) {
                                return idx;  // ë¶ˆì™„ì „ - ì´ ìœ„ì¹˜ê¹Œì§€ë§Œ ìœ íš¨
                            }
                        }
                    }
                    return buffer.length;  // ì „ì²´ê°€ ìœ íš¨
                }

                let pendingBytes = new Uint8Array(0);

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ - ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
                        if (pendingBytes.length > 0) {
                            const finalText = decoder.decode(pendingBytes);
                            lineBuffer += finalText;
                        }
                        break;
                    }

                    // ì´ì „ pending ë°”ì´íŠ¸ì™€ ìƒˆ ë°ì´í„° ë³‘í•©
                    const combined = new Uint8Array(pendingBytes.length + value.length);
                    combined.set(pendingBytes);
                    combined.set(value, pendingBytes.length);

                    // ì™„ì „í•œ UTF-8 ë ìœ„ì¹˜ ì°¾ê¸°
                    const validEnd = findCompleteUtf8End(combined);

                    // ì™„ì „í•œ ë¶€ë¶„ë§Œ ë””ì½”ë”©
                    const completeBytes = combined.slice(0, validEnd);
                    pendingBytes = combined.slice(validEnd);

                    if (completeBytes.length > 0) {
                        const text = decoder.decode(completeBytes, { stream: true });
                        lineBuffer += text;
                    }

                    // ì™„ì „í•œ ë¼ì¸ë§Œ ì²˜ë¦¬ (ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬)
                    const lines = lineBuffer.split('\n');
                    lineBuffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6).trim();
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                let content = parsed.choices[0]?.delta?.content;
                                if (content) {
                                    // íŠ¹ìˆ˜ í† í° ì œê±° (ì›ë³¸ ëˆ„ì ìš©)
                                    content = content
                                        .replace(/<\|im_end\|>/g, '')
                                        .replace(/<\|im_start\|>/g, '');
                                    assistantMessage += content;
                                    // í™”ë©´ í‘œì‹œìš©: ì™„ë£Œ ì‹œì™€ ë™ì¼í•œ í•„í„° ì ìš©
                                    let displayMessage = assistantMessage
                                        .replace(/<think>[\s\S]*?<\/think>/g, '')  // thinking mode íƒœê·¸
                                        .replace(/<\|im_end\|>/g, '')              // ì¢…ë£Œ í† í°
                                        .replace(/<\|im_start\|>/g, '')            // ì‹œì‘ í† í°
                                        .replace(/\?\?/g, '')                       // ê¹¨ì§„ ì´ëª¨ì§€
                                        .replace(/ï¿½/g, '')                          // replacement character
                                        .replace(/[\uFFFD]/g, '')                   // Unicode replacement char
                                        .replace(/[\u0000-\u001F]/g, '');           // control characters
                                    streamingMessageDiv.textContent = displayMessage;
                                    container.scrollTop = container.scrollHeight;
                                }
                            } catch (e) {
                                // JSON íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
                            }
                        }
                    }
                }

                // ë‚¨ì€ lineBuffer ì²˜ë¦¬
                if (lineBuffer.length > 0) {
                    const lines = lineBuffer.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6).trim();
                            if (data === '[DONE]') continue;
                            try {
                                const parsed = JSON.parse(data);
                                let content = parsed.choices[0]?.delta?.content;
                                if (content) {
                                    content = content
                                        .replace(/<\|im_end\|>/g, '')
                                        .replace(/<\|im_start\|>/g, '');
                                    assistantMessage += content;
                                }
                            } catch (e) {}
                        }
                    }
                    // ë‚¨ì€ ë²„í¼ ì²˜ë¦¬ í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                    let displayMessage = assistantMessage
                        .replace(/<think>[\s\S]*?<\/think>/g, '')
                        .replace(/<\|im_end\|>/g, '')
                        .replace(/<\|im_start\|>/g, '')
                        .replace(/\?\?/g, '')
                        .replace(/ï¿½/g, '')
                        .replace(/[\uFFFD]/g, '')
                        .replace(/[\u0000-\u001F]/g, '');
                    streamingMessageDiv.textContent = displayMessage;
                }

                // ìŠ¤íŠ¸ë¦¬ë° ID ì œê±°
                streamingMessageDiv.removeAttribute('id');

                // ìµœì¢… ì •ë¦¬: trim ì ìš©
                const cleanedMessage = assistantMessage
                    .replace(/<think>[\s\S]*?<\/think>/g, '')  // thinking mode íƒœê·¸
                    .replace(/<\|im_end\|>/g, '')              // ì¢…ë£Œ í† í°
                    .replace(/<\|im_start\|>/g, '')            // ì‹œì‘ í† í°
                    .replace(/\?\?/g, '')                       // ê¹¨ì§„ ì´ëª¨ì§€
                    .replace(/ï¿½/g, '')                          // replacement character
                    .replace(/[\uFFFD]/g, '')                   // Unicode replacement char
                    .replace(/[\u0000-\u001F]/g, '')            // control characters
                    .trim();

                // trimìœ¼ë¡œ ì¸í•œ ì°¨ì´ë§Œ ì—…ë°ì´íŠ¸ (ë‚´ìš© ë³€ê²½ ìµœì†Œí™”)
                if (streamingMessageDiv.textContent !== cleanedMessage) {
                    streamingMessageDiv.textContent = cleanedMessage;
                }
                assistantMessage = cleanedMessage;

                // ë©”ì‹œì§€ ê¸°ë¡ì— ì¶”ê°€
                messageHistory.push({
                    role: 'assistant',
                    content: assistantMessage
                });

                // ëŒ€í™” ì €ì¥
                saveCurrentConversation();

            } catch (error) {
                hideTypingIndicator();
                addSystemMessage('âŒ ì˜¤ë¥˜: ' + error.message);
            } finally {
                document.getElementById('sendBtn').disabled = false;
                isSending = false; // ì „ì†¡ ì™„ë£Œ, í”Œë˜ê·¸ í•´ì œ
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            const avatarEmoji = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const roleName = role === 'user' ? 'ì§€ì›ì' : 'ë©´ì ‘ê´€';
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarEmoji}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-role">${roleName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${content}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
        function addSystemMessage(content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.innerHTML = `<div class="message-text">${content}</div>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
        function showTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'typing-indicator active';
            indicator.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ëŒ€í™” ì €ì¥
        function saveCurrentConversation() {
            if (!currentConversationId) return;

            const conversation = conversations.find(c => c.id === currentConversationId);
            if (conversation) {
                conversation.messages = messageHistory;
                conversation.timestamp = Date.now();

                // ì²« ë©”ì‹œì§€ë¡œ ì œëª© ì„¤ì •
                if (messageHistory.length > 0) {
                    const firstUserMessage = messageHistory.find(m => m.role === 'user');
                    if (firstUserMessage) {
                        conversation.title = firstUserMessage.content.substring(0, 30) + '...';
                    }
                }

                saveConversations();
                loadChatHistory();
            }
        }

        // ëŒ€í™” ëª©ë¡ ì €ì¥
        function saveConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        // ëŒ€í™” ê¸°ë¡ ë¡œë“œ
        function loadChatHistory() {
            const historyContainer = document.getElementById('chatHistory');
            historyContainer.innerHTML = '';

            if (conversations.length === 0) {
                historyContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px; font-size: 13px;">ì €ì¥ëœ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'chat-history-item';
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }
                item.textContent = conv.title;
                item.onclick = () => loadConversation(conv.id);
                historyContainer.appendChild(item);
            });
        }

        // íŠ¹ì • ëŒ€í™” ë¡œë“œ
        function loadConversation(id) {
            const conversation = conversations.find(c => c.id === id);
            if (!conversation) return;

            currentConversationId = id;
            messageHistory = [...conversation.messages];

            // ì›°ì»´ ìŠ¤í¬ë¦° ìˆ¨ê¸°ê¸°
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            // ë©”ì‹œì§€ í‘œì‹œ
            messageHistory.forEach(msg => {
                addMessage(msg.role, msg.content);
            });

            loadChatHistory();
        }

        // ëª¨ë“  ëŒ€í™” ì‚­ì œ
        function clearAllChats() {
            if (confirm('ëª¨ë“  ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                conversations = [];
                currentConversationId = null;
                messageHistory = [];
                saveConversations();
                loadChatHistory();

                // ì›°ì»´ ìŠ¤í¬ë¦° í‘œì‹œ
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'flex';
                }
            }
        }

        // ì´ë ¥ì„œ ì œê±°
        async function removeResume() {
            if (resumeSessionId) {
                try {
                    await fetch(`${RESUME_ENDPOINT}/${resumeSessionId}`, {
                        method: 'DELETE'
                    });
                } catch (e) {
                    console.error('ì´ë ¥ì„œ ì‚­ì œ ì‹¤íŒ¨:', e);
                }
            }

            resumeSessionId = null;
            resumeSummary = null;
            document.getElementById('resumeInfo').style.display = 'none';
            document.getElementById('resumeRagStatus').textContent = 'ì´ë ¥ì„œ ì²¨ë¶€ ì‹œ ê´€ë ¨ ë‚´ìš© ìë™ ê²€ìƒ‰';

            // ì´ë ¥ì„œ RAG ë¹„í™œì„±í™”
            document.getElementById('resumeRagEnabled').checked = false;
            updateResumeRagStatus();

            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë³µì›
            resetSystemPrompt();
            addSystemMessage('ğŸ“„ ì´ë ¥ì„œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ì´ë ¥ì„œ ì •ë³´ ì¶”ê°€
        function updateSystemPromptWithResume() {
            if (!resumeSummary) return;

            // ì´ë ¥ì„œ RAGê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì „ì²´ ì£¼ì… ê±´ë„ˆë›°ê¸°
            const resumeRagEnabled = document.getElementById('resumeRagEnabled').checked;
            if (resumeRagEnabled) {
                const basePrompt = 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”.';
                const resumeContext = `

[ì´ë ¥ì„œ ì²¨ë¶€ë¨ - RAGë¡œ ê´€ë ¨ ë‚´ìš© ìë™ ê²€ìƒ‰]
ì´ë ¥ì„œê°€ ì²¨ë¶€ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ì´ë ¥ì„œ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì°¸ì¡°ë©ë‹ˆë‹¤. /nothink`;
                document.getElementById('systemPrompt').value = basePrompt + resumeContext;
                return;
            }

            const basePrompt = 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”.';
            const resumeContext = `

[ì§€ì›ì ì´ë ¥ì„œ ì •ë³´]
${resumeSummary}

ìœ„ ì´ë ¥ì„œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì§€ì›ìì˜ ê²½ë ¥, ê¸°ìˆ , í”„ë¡œì íŠ¸ ê²½í—˜ì— ëŒ€í•´ êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”. /nothink`;

            document.getElementById('systemPrompt').value = basePrompt + resumeContext;
        }

        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë³µì›
        function resetSystemPrompt() {
            document.getElementById('systemPrompt').value = 'ë‹¹ì‹ ì€ ì „ë¬¸ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”. /nothink';
        }

        // ì´ë ¥ì„œ RAG ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateResumeRagStatus() {
            const enabled = document.getElementById('resumeRagEnabled').checked;
            const statusEl = document.getElementById('resumeRagStatus');
            if (enabled && resumeSessionId) {
                statusEl.textContent = 'âœ… ì´ë ¥ì„œ RAG í™œì„±í™”ë¨';
                statusEl.style.color = '#10b981';
            } else if (resumeSessionId) {
                statusEl.textContent = 'ì´ë ¥ì„œ ì²¨ë¶€ë¨ (RAG ë¹„í™œì„±í™”)';
                statusEl.style.color = '#f59e0b';
            } else {
                statusEl.textContent = 'ì´ë ¥ì„œ ì²¨ë¶€ ì‹œ ê´€ë ¨ ë‚´ìš© ìë™ ê²€ìƒ‰';
                statusEl.style.color = '#94a3b8';
            }
        }

        // ì§ˆë¬¸ì…‹ RAG ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateQuestionSetRagStatus() {
            const enabled = document.getElementById('questionSetRagEnabled').checked;
            const statusEl = document.getElementById('questionSetRagStatus');
            const jobInfo = getSelectedOrgJobInfo();

            if (enabled && jobInfo && jobInfo.job) {
                statusEl.textContent = `âœ… ${jobInfo.job} ì§ˆë¬¸ì…‹ RAG í™œì„±í™”ë¨`;
                statusEl.style.color = '#10b981';
            } else if (jobInfo && jobInfo.job) {
                statusEl.textContent = `${jobInfo.job} ì§ˆë¬¸ì…‹ ì‚¬ìš© ê°€ëŠ¥ (RAG ë¹„í™œì„±í™”)`;
                statusEl.style.color = '#f59e0b';
            } else {
                statusEl.textContent = 'ì§ë¬´ ì„ íƒ ì‹œ ê´€ë ¨ ì§ˆë¬¸ ìë™ ê²€ìƒ‰';
                statusEl.style.color = '#94a3b8';
            }
        }

        // ì´ë ¥ì„œ RAG í† ê¸€ ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('resumeRagEnabled').addEventListener('change', updateResumeRagStatus);

        // ì§ˆë¬¸ì…‹ RAG í† ê¸€ ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('questionSetRagEnabled').addEventListener('change', updateQuestionSetRagStatus);

        // 10ì´ˆë§ˆë‹¤ ì„œë²„ ìƒíƒœ í™•ì¸
        setInterval(checkServerStatus, 10000);

        // ==================== ê¸°ì—…/ë³‘ì› ì„ íƒ ê¸°ëŠ¥ ====================

        // ìœ í˜• ë³€ê²½ ì‹œ (ì¼ë°˜ ê¸°ì—… / ë³‘ì›)
        async function onOrgTypeChange() {
            const orgType = document.getElementById('orgTypeSelect').value;
            selectedOrgType = orgType;
            selectedOrg = '';
            selectedJob = '';

            // ì´ˆê¸°í™”
            document.getElementById('orgSelectGroup').style.display = 'none';
            document.getElementById('jobSelectGroup').style.display = 'none';
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('customOrgInput').style.display = 'none';
            document.getElementById('customJobInput').style.display = 'none';

            if (!orgType) {
                orgData = null;
                return;
            }

            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/organizations/${orgType}`);
                if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

                orgData = await response.json();

                // ê¸°ì—…/ë³‘ì› ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                const orgSelect = document.getElementById('orgSelect');
                orgSelect.innerHTML = '<option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>';
                orgData.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org;
                    option.textContent = org;
                    orgSelect.appendChild(option);
                });

                document.getElementById('orgSelectGroup').style.display = 'block';

            } catch (error) {
                console.error('ê¸°ì—…/ë³‘ì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                addSystemMessage('âŒ ê¸°ì—…/ë³‘ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ê¸°ì—…/ë³‘ì› ì„ íƒ ë³€ê²½
        function onOrgChange() {
            const org = document.getElementById('orgSelect').value;
            selectedOrg = org;
            selectedJob = '';

            document.getElementById('customOrgInput').style.display = 'none';
            document.getElementById('jobSelectGroup').style.display = 'none';
            document.getElementById('customJobInput').style.display = 'none';

            if (!org) {
                document.getElementById('selectedInfo').style.display = 'none';
                return;
            }

            // "ì§ì ‘ ì…ë ¥" ì„ íƒ ì‹œ
            if (org === 'ì§ì ‘ ì…ë ¥') {
                document.getElementById('customOrgInput').style.display = 'block';
                document.getElementById('customOrgInput').value = '';
                document.getElementById('customOrgInput').focus();
            }

            // ì§ë¬´ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° - ëª¨ë“  íšŒì‚¬ì— ë™ì¼í•œ ì „ì²´ ì§ë¬´ ëª©ë¡ í‘œì‹œ
            const jobSelect = document.getElementById('jobSelect');
            jobSelect.innerHTML = '<option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>';

            // í•­ìƒ ì „ì²´ ì§ë¬´ ëª©ë¡ í‘œì‹œ (ê¸°ì—…ë³„ ë§¤í•‘ ë¬´ì‹œ)
            orgData.jobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job;
                option.textContent = job;
                jobSelect.appendChild(option);
            });

            document.getElementById('jobSelectGroup').style.display = 'block';
            updateSelectedInfo();
        }

        // ì§ë¬´ ì„ íƒ ë³€ê²½
        async function onJobChange() {
            const job = document.getElementById('jobSelect').value;
            selectedJob = job;

            document.getElementById('customJobInput').style.display = 'none';
            currentQuestionSet = null;  // ì§ˆë¬¸ì…‹ ì´ˆê¸°í™”

            // "ì§ì ‘ ì…ë ¥" ì„ íƒ ì‹œ
            if (job === 'ì§ì ‘ ì…ë ¥') {
                document.getElementById('customJobInput').style.display = 'block';
                document.getElementById('customJobInput').value = '';
                document.getElementById('customJobInput').focus();
            } else if (job) {
                // ì§ˆë¬¸ì…‹ ë¡œë“œ
                await loadQuestionSet();

                // ì§ˆë¬¸ì…‹ RAG ìë™ í™œì„±í™”
                document.getElementById('questionSetRagEnabled').checked = true;
                updateQuestionSetRagStatus();
            }

            updateSelectedInfo();
        }

        // ì§ˆë¬¸ì…‹ ë¡œë“œ
        async function loadQuestionSet() {
            if (!selectedOrgType || !selectedJob || selectedJob === 'ì§ì ‘ ì…ë ¥') {
                currentQuestionSet = null;
                return;
            }

            // UI ì§ë¬´ëª… â†’ API íŒŒë¼ë¯¸í„° ë³€í™˜
            const orgTypeParam = selectedOrgType === 'company' ? 'ì¼ë°˜ê¸°ì—…' : 'ë³‘ì›';

            // ì§ë¬´ëª…ì—ì„œ ìŠ¬ë˜ì‹œ ì œê±° (ë§ˆì¼€íŒ…/ì˜ì—… â†’ ë§ˆì¼€íŒ…ì˜ì—…)
            const jobNameParam = selectedJob.replace(/\//g, '');

            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/question-sets/${encodeURIComponent(orgTypeParam)}/${encodeURIComponent(jobNameParam)}`);
                if (response.ok) {
                    const data = await response.json();
                    currentQuestionSet = data.text;
                    console.log(`ì§ˆë¬¸ì…‹ ë¡œë“œë¨: ${orgTypeParam}_${jobNameParam} (${data.count}ê°œ ì§ˆë¬¸)`);
                } else {
                    console.log(`ì§ˆë¬¸ì…‹ ì—†ìŒ: ${orgTypeParam}_${jobNameParam}`);
                    currentQuestionSet = null;
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ì…‹ ë¡œë“œ ì‹¤íŒ¨:', error);
                currentQuestionSet = null;
            }
        }

        // ì„ íƒ ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSelectedInfo() {
            const customOrg = document.getElementById('customOrgInput').value.trim();
            const customJob = document.getElementById('customJobInput').value.trim();

            const orgName = selectedOrg === 'ì§ì ‘ ì…ë ¥' ? customOrg : selectedOrg;
            const jobName = selectedJob === 'ì§ì ‘ ì…ë ¥' ? customJob : selectedJob;

            if (orgName || jobName) {
                let infoText = '';
                if (orgName) infoText += `ğŸ¢ ${orgName}`;
                if (jobName) infoText += ` / ğŸ’¼ ${jobName}`;
                document.getElementById('selectedOrgJob').textContent = infoText;
                document.getElementById('selectedInfo').style.display = 'block';
            } else {
                document.getElementById('selectedInfo').style.display = 'none';
            }
        }

        // ì„ íƒëœ ê¸°ì—…/ì§ë¬´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getSelectedOrgJobInfo() {
            const customOrg = document.getElementById('customOrgInput')?.value.trim() || '';
            const customJob = document.getElementById('customJobInput')?.value.trim() || '';

            const orgName = selectedOrg === 'ì§ì ‘ ì…ë ¥' ? customOrg : selectedOrg;
            const jobName = selectedJob === 'ì§ì ‘ ì…ë ¥' ? customJob : selectedJob;

            if (!orgName && !jobName) return null;

            return {
                type: selectedOrgType === 'company' ? 'ì¼ë°˜ ê¸°ì—…' : 'ë³‘ì›',
                organization: orgName,
                job: jobName
            };
        }

        // ==================== í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ê¸°ëŠ¥ (20ë…„ì°¨ ì „ë¬¸ ë©´ì ‘ê´€ ì „ìš©) ====================

        // ì „ë¬¸ ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì¼ì—ì„œ)
        async function loadExpertPrompt() {
            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/file/content`);
                if (!response.ok) {
                    console.log('í”„ë¡¬í”„íŠ¸ íŒŒì¼ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
                    return;
                }

                const data = await response.json();
                document.getElementById('systemPrompt').value = data.content;

            } catch (error) {
                console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì „ë¬¸ ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ ì €ì¥ (íŒŒì¼ì—)
        async function saveExpertPrompt() {
            const content = document.getElementById('systemPrompt').value.trim();

            if (!content) {
                alert('ì €ì¥í•  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/file/content`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (!response.ok) throw new Error('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨');

                const data = await response.json();
                addSystemMessage(`ğŸ’¾ í”„ë¡¬í”„íŠ¸ê°€ íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                alert('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ==================== RAG ë¬¸ì„œ ê´€ë¦¬ ê¸°ëŠ¥ ====================

        // RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ
        async function loadRAGDocuments() {
            try {
                const response = await fetch(`${RAG_ENDPOINT}/documents`);
                if (!response.ok) throw new Error('ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');

                const data = await response.json();
                const docsList = document.getElementById('ragDocsList');
                const statusEl = document.getElementById('ragStatus');

                docsList.innerHTML = '';

                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(doc => {
                        const docItem = document.createElement('div');
                        docItem.className = 'rag-doc-item';
                        docItem.innerHTML = `
                            <span class="doc-name" title="${doc.filename}">${doc.filename}</span>
                            <button class="doc-delete" onclick="deleteRAGDocument(${doc.id})" title="ì‚­ì œ">âœ•</button>
                        `;
                        docsList.appendChild(docItem);
                    });
                    statusEl.textContent = `ë¬¸ì„œ ${data.documents.length}ê°œ ë“±ë¡ë¨`;
                    statusEl.className = 'rag-status active';
                } else {
                    docsList.innerHTML = '<div style="color: #64748b; font-size: 11px; text-align: center; padding: 10px;">ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ</div>';
                    statusEl.textContent = 'ë¬¸ì„œ 0ê°œ ë“±ë¡ë¨';
                    statusEl.className = 'rag-status';
                }

            } catch (error) {
                console.error('RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // RAG ë¬¸ì„œ ì—…ë¡œë“œ
        async function uploadRAGDocument(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const uploadBtn = document.querySelector('.rag-upload-btn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = 'â³ ì—…ë¡œë“œ ì¤‘...';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('collection_name', 'default');

                const response = await fetch(`${RAG_ENDPOINT}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'PDF ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                await loadRAGDocuments();  // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                addSystemMessage(`ğŸ“š ë¬¸ì„œ "${file.name}" ì—…ë¡œë“œ ì™„ë£Œ (${data.chunk_count}ê°œ ì²­í¬)`);

                // RAG ìë™ í™œì„±í™”
                document.getElementById('ragEnabled').checked = true;

            } catch (error) {
                alert('ë¬¸ì„œ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                event.target.value = '';  // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥
            }
        }

        // ì´ë ¥ì„œ PDF ì—…ë¡œë“œ
        async function uploadResumeDocument(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const uploadBtn = document.getElementById('resumeUploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = 'â³ ì—…ë¡œë“œ ì¤‘...';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${RESUME_ENDPOINT}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ì´ë ¥ì„œ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();

                // ì„¸ì…˜ ID ì €ì¥
                resumeSessionId = data.session_id;

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('resumeInfo').style.display = 'flex';
                document.getElementById('resumeFilename').textContent = file.name;

                // ì´ë ¥ì„œ RAG ìë™ í™œì„±í™”
                document.getElementById('resumeRagEnabled').checked = true;
                updateResumeRagStatus();

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                document.getElementById('resumeRagStatus').textContent =
                    `âœ… "${file.name}" (${data.chunk_count}ê°œ ì²­í¬)`;

                addSystemMessage(`ğŸ“„ ì´ë ¥ì„œ "${file.name}" ì—…ë¡œë“œ ì™„ë£Œ (${data.chunk_count}ê°œ ì²­í¬ë¡œ ì¸ë±ì‹±ë¨)`);

            } catch (error) {
                alert('ì´ë ¥ì„œ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                event.target.value = '';  // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥
            }
        }

        // RAG ë¬¸ì„œ ì‚­ì œ
        async function deleteRAGDocument(docId) {
            if (!confirm('ì´ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`${RAG_ENDPOINT}/documents/${docId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨');

                await loadRAGDocuments();  // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                addSystemMessage('ğŸ“š ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                alert('ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>

    <!-- í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
    <div class="prompt-modal-overlay" id="promptModalOverlay" onclick="closePromptModal(event)">
        <div class="prompt-modal" onclick="event.stopPropagation()">
            <div class="prompt-modal-header">
                <h3>ğŸ“ 20ë…„ì°¨ ì „ë¬¸ ë©´ì ‘ê´€ í”„ë¡¬í”„íŠ¸ í¸ì§‘</h3>
                <button class="prompt-modal-close" onclick="closePromptModal()">&times;</button>
            </div>
            <div class="prompt-modal-body">
                <textarea class="prompt-modal-textarea" id="promptModalTextarea" placeholder="í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <div class="prompt-modal-footer">
                <div class="prompt-modal-info">
                    <span id="promptModalInfo">íŒŒì¼: prompts/interview_expert.txt</span>
                </div>
                <div class="prompt-modal-actions">
                    <button class="prompt-modal-btn reload" onclick="reloadPromptInModal()">ğŸ“¥ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="prompt-modal-btn cancel" onclick="closePromptModal()">ì·¨ì†Œ</button>
                    <button class="prompt-modal-btn save" onclick="savePromptFromModal()">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ì—´ê¸°
        function openPromptModal() {
            const overlay = document.getElementById('promptModalOverlay');
            const textarea = document.getElementById('promptModalTextarea');

            // í˜„ì¬ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë‚´ìš© ë³µì‚¬
            textarea.value = document.getElementById('systemPrompt').value;

            overlay.classList.add('active');
            textarea.focus();

            // ESC í‚¤ë¡œ ë‹«ê¸°
            document.addEventListener('keydown', handleModalEsc);
        }

        // í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePromptModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const overlay = document.getElementById('promptModalOverlay');
            overlay.classList.remove('active');

            document.removeEventListener('keydown', handleModalEsc);
        }

        // ESC í‚¤ í•¸ë“¤ëŸ¬
        function handleModalEsc(e) {
            if (e.key === 'Escape') {
                closePromptModal();
            }
        }

        // ëª¨ë‹¬ì—ì„œ í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function reloadPromptInModal() {
            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/file/content`);
                if (!response.ok) throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

                const data = await response.json();
                document.getElementById('promptModalTextarea').value = data.content;
                document.getElementById('promptModalInfo').textContent = `íŒŒì¼: prompts/interview_expert.txt | ë§ˆì§€ë§‰ ìˆ˜ì •: ${new Date(data.updated_at).toLocaleString('ko-KR')}`;

            } catch (error) {
                alert('í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ëª¨ë‹¬ì—ì„œ í”„ë¡¬í”„íŠ¸ ì €ì¥
        async function savePromptFromModal() {
            const content = document.getElementById('promptModalTextarea').value.trim();

            if (!content) {
                alert('ì €ì¥í•  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch(`${PROMPTS_ENDPOINT}/file/content`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

                const data = await response.json();

                // ë©”ì¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì—ë„ ë°˜ì˜
                document.getElementById('systemPrompt').value = content;

                // ì •ë³´ ì—…ë°ì´íŠ¸
                document.getElementById('promptModalInfo').textContent = `íŒŒì¼: prompts/interview_expert.txt | ì €ì¥ë¨: ${new Date().toLocaleString('ko-KR')}`;

                addSystemMessage('ğŸ’¾ í”„ë¡¬í”„íŠ¸ê°€ íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëª¨ë‹¬ ë‹«ê¸°
                closePromptModal();

            } catch (error) {
                alert('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>
</body>
</html>
